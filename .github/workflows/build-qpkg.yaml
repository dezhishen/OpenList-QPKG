name: Build OpenList QPKG with Tag and Release and Multi-Resolution Logo

on:
  workflow_dispatch:
    inputs:
      version:
        description: "OpenList release版本号，比如 v1.14.1，latest自动选新"
        required: false
        default: "latest"
      edition:
        description: "版本：normal/lite，留空则全打"
        required: false
        default: ""
      arch:
        description: "架构如arm64, amd64等，留空则全打"
        required: false
        default: ""

permissions:
  actions: write
  contents: write

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build_and_tag:
    runs-on: ubuntu-latest
    steps:
      - name: checkout主分支
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 构建QPKG产物和配置
        run: |
          set -e
          cat > build_conf <<EOF
          VERSION=${{ github.event.inputs.version }}
          ARCHS=${{ github.event.inputs.arch }}
          EDITION=${{ github.event.inputs.edition }}
          EOF
          chmod +x scripts/build.sh
          scripts/build.sh

      - name: 处理分支/Tag/提交
        run: |
          set -e
          ver=$(grep -E '^VERSION=' build_conf | head -n 1 | cut -d= -f2-)
          branch="release/$ver"
          tag="$ver"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          tmp_dir=$(mktemp -d)
          mv out "$tmp_dir/"
          mv build_conf "$tmp_dir/"
          mv build.sh "$tmp_dir/"
          mv qpkg-template "$tmp_dir/"
          mv build_args "$tmp_dir/"
          git checkout --orphan $branch
          git rm -rf .
          git clean -fdx
          mv "$tmp_dir/qpkg-template" ./qpkg-template
          mv "$tmp_dir/build_args" ./build_args
          mv "$tmp_dir/build.sh" ./build.sh
          mv "$tmp_dir/build_conf" ./build_conf
          mv "$tmp_dir/out" ./out
          git add qpkg-template build_args build.sh
          git commit -m "release $ver QPKG and config"
          git push origin $branch --force
          git tag -d $tag || true
          git push origin :refs/tags/$tag || true
          git tag $tag
          git push origin $tag --force

      - name: 发布Release并上传QPKG产物
        run: |
          set -e
          ver=$(grep -E '^VERSION=' build_conf | head -n 1 | cut -d= -f2-)
          repo="${{ github.repository }}"
          api="https://api.github.com/repos/$repo"
          auth_header="Authorization: token $GH_TOKEN"
          release_json=$(wget -qO- --header="$auth_header" "$api/releases/tags/$ver" || true)
          release_id=$(echo "$release_json" | sed -n 's/.*"id"[[:space:]]*:[[:space:]]*\([0-9]*\).*/\1/p' | head -n 1)
          if [ -z "$release_id" ]; then
            body=$(printf '{"tag_name":"%s","name":"%s QNAP QPKG","body":"自动产出OpenList QPKG，包括全部配置和脚本。","draft":false,"prerelease":false}' "$ver" "$ver")
            release_json=$(wget -qO- --header="$auth_header" --header="Content-Type: application/json" --method=POST --body-data="$body" "$api/releases")
            release_id=$(echo "$release_json" | sed -n 's/.*"id"[[:space:]]*:[[:space:]]*\([0-9]*\).*/\1/p' | head -n 1)
          fi
          if [ -z "$release_id" ]; then
            echo "创建/获取 Release 失败"
            exit 1
          fi
          for f in out/qpkg-output/*.qpkg.tar.gz; do
            name=$(basename "$f")
            wget -q --header="$auth_header" --header="Content-Type: application/gzip" \
              --method=POST --body-file="$f" \
              "https://uploads.github.com/repos/$repo/releases/$release_id/assets?name=$name" || true
          done